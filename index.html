<!DOCTYPE html>
<html lang="en-US" class="supports_custom_scrollbar">
<head>
<style>
* {margin: 0; padding: 0}
html, body {width: 100%; height: 100%; overflow: hidden;}
</style>
</head>
<body astyle="background-color:#000">
<canvas id="canvas" style="border: solid 1px #000;"></canvas>

</body>


<script type="text/javascript">
var SR = {};

Object.inherits = function(ctor, superCtor) {
    ctor.super_ = superCtor;
    return ctor.prototype = Object.create(superCtor.prototype, {
        constructor: {
            value: ctor,
            enumerable: false,
            writable: true,
            configurable: true
        }
    });
}
</script>
<script type="text/javascript" src="./src/math.js"></script>
<script type="text/javascript" src="./src/surface.js"></script>
<script type="text/javascript" src="./src/mesh.js"></script>
<script type="text/javascript" src="./src/renderable.js"></script>
<script type="text/javascript" src="./src/scene.js"></script>
<script type="text/javascript" src="./src/light.js"></script>
<script type="text/javascript" src="./src/shader.js"></script>
<script type="text/javascript" src="./src/rasterizer.js"></script>
<script type="text/javascript" src="./src/trirotate.js"></script>
<script type="text/javascript" src="./src/shadow.js"></script>
<script type="text/javascript" src="./src/renderer.js"></script>

<script>
var renderer = new SR.Renderer(800, 600, new DomSurface(document.getElementById('canvas')) );
renderer.setPerspective(0.1, 100, 90*Math.PI/180);
renderer.shader = new GouraudShader();
//renderer.shader = new MinimalShader();


var scene = new SR.Scene();

scene.addLight( new Light(Light.Type.Point, {
    point: new Point(0, -5.5,2),
    intensity: 0.003
}) )
/*scene.addLight( new Light(Light.Type.Directional, {
    normal: (new Point(-1,-1,1)).normalize(),
    intensity: 0.0015
}))*/
scene.addLight( new Light(Light.Type.Ambient, {
    intensity: 0.0018
}))

var cube = scene.add( new Renderable( new TriangleMesh( Shapes.makeCube(0,0,0,255) ) )  );
/*var cube2 = scene.add( new Renderable( new TriangleMesh( Shapes.makeCube(100,100,100,255) ) )  );
cube2.mesh.buildShadowVolumen();
cube2.translate(0,-1,0);*/

//scene.add( new Renderable( new TriangleMesh( Shapes.makePlane(125,125,125,255) ) ) ).scale(5);


var fMesh = new FastPix3dMesh(),
    renderMesh = new SR.Renderable(fMesh);
fMesh.load('model/Swift.fp3d', function(){
    fMesh.buildShadowVolumen();
    renderAni();
});
scene.add( renderMesh ).rotx(Math.PI);

renderer.drawCounter= 0;




var val = 0,
    lightMatrix = new Matrix4();
function renderLoop() {
    val += 0.01;

    renderer.surface.clear();

    scene.camera.set( Matrix4.IDENTITY );
    scene.camera.translate(0, -2, -24);
    scene.camera.rotx( 40 * Math.PI/180  );
    //scene.camera.roty( 15 * Math.PI/180  );
    //scene.camera.roty( val * Math.PI  );

    lightMatrix.set(Matrix4.IDENTITY);
    lightMatrix.roty(val * Math.PI);
    lightMatrix.translate(0, -1, 5);
    Point.transform( scene.lights[0].point, Point.Zero, lightMatrix );
    
    cube.setMatrix(lightMatrix);
    cube.scale(0.25)


    renderer.renderer(scene);
    renderer.surface.flush();
}
//renderLoop();


function benchMark(inner, outer) {
    inner = inner || 50;
    outer = outer || 10;

    var times = new Array(outer);

    for(var o = 0;o<outer;o++) {
        var start = performance.now(),
            counter = inner;
        while(counter--)
            renderLoop();
        //console.log( (performance.now() - start) / 100 )
        times[o] = (performance.now() - start) / inner;
    }

    var min = Infinity,
        max = -Infinity,
        avg = 0;
    for(var i=0;i<outer;i++) {
        var time = times[i];
        if(time < min) min = time;
        if(time > max) max = time;
        avg += time;
    }
    console.log('avg: '+(avg/outer).toFixed(3)+' min: '+min.toFixed(2)+' max:'+max.toFixed(2));
}
//benchMark();




function  renderAni() {
    var counter = 0,
        start = Date.now(),
        theInterval = setInterval(function(){
            renderLoop();
            if(++counter === 200) {
                console.log( (Date.now() - start) / 200 )
                clearInterval(theInterval);
            }

        })
}



/*
536.6
*/

</script>



</html>